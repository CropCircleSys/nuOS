--- ../npm.orig/Makefile	2020-09-21 22:21:06.174033000 +0000
+++ ./Makefile	2020-09-21 22:22:49.195488000 +0000
@@ -2,8 +2,7 @@
 # $FreeBSD: head/www/npm/Makefile 533054 2020-04-26 11:59:37Z sunpoet $
 
 PORTNAME=	npm
-PORTVERSION=	6.12.1
-PORTREVISION=	1
+PORTVERSION=	6.14.8
 CATEGORIES=	www
 MASTER_SITES=	LOCAL/sunpoet
 
@@ -15,13 +14,14 @@
 
 RUN_DEPENDS=	gmake:devel/gmake
 
-USES=		cpe python:run shebangfix tar:xz
+USES=		cpe python:3.5+ shebangfix tar:xz
+USE_PYTHON=	noflavors
 
 NO_ARCH=	yes
 NO_BUILD=	yes
 REINPLACE_ARGS=	-i ''
 
-CONFLICTS_INSTALL?=	npm-node10 npm-node12 npm-node8
+CONFLICTS_INSTALL?=	npm-node10 npm-node12
 
 OPTIONS_SINGLE=	BACKEND
 OPTIONS_SINGLE_BACKEND=	NODE NODE10 NODE12
@@ -50,9 +50,12 @@
 post-patch:
 	@${REINPLACE_CMD} -e 's|/usr/local|${PREFIX}|' ${WRKSRC}/etc/man.d/npm.conf
 	@${REINPLACE_CMD} -e 's|/usr/local|${LOCALBASE}|' ${WRKSRC}/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp
+	@${REINPLACE_CMD} -e 's|exec python |exec ${PYTHON_CMD} |' ${WRKSRC}/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp
 	@${FIND} ${WRKSRC}/ -name '*.sh' -exec ${REINPLACE_CMD} -e '1 s|/usr/local|${LOCALBASE}|' {} +
 
 do-install:
 	cd ${WRKSRC}/ && ${COPYTREE_SHARE} . ${STAGEDIR}${PREFIX}/
+	${ECHO_CMD} 'python=${PYTHON_CMD}' > ${STAGEDIR}${PREFIX}/etc/npmrc
+	${PYTHON_CMD} ${PYTHON_LIBDIR}/compileall.py -d ${PREFIX}/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp -f ${STAGEDIR}${PREFIX}/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp
 
 .include <bsd.port.post.mk>
