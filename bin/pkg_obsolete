#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.9.3b0 - bin/pkg_obsolete - LICENSE: PUB_DOM
#
# Written in 2013 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is placed in the public domain by the author, who disclaims all
# liability. More information can be found in the license file.
#
# Official updates and community support available at http://nuos.org .
# Other licensing options and professional services available at http://ccsys.com .

while getopts doru OPT; do case $OPT in
	d) OPT_DELETE=y;;
	o) OPT_ORIGIN=y;;
	r) OPT_RECURSE=y;;
	u) OPT_UNINSTALL=y;;
esac; done; shift $(($OPTIND-1))
[ $# = 0 ]

report () {
	while [ -t = $1 ]; do
		echo -n '	'
		shift
	done
	if [ -n "${OPT_ORIGIN-}" ]; then
		pkg_info -q -o $1
	else
		echo $1
	fi
}

maybe_delete () {
	if [ -n "${OPT_DELETE-}" -a -f /usr/ports/packages/All/$1.tbz ]; then
		rm /usr/ports/packages/*/$1.tbz
	fi
}

maybe_uninstall () {
	if [ -n "${OPT_UNINSTALL-}" -a -d /var/db/pkg/$1 ]; then
		pkg_delete -f $1
	fi
}

for pkg in `portversion -v -l '<' | cut -w -f 1`; do
	report $pkg
	if [ -n "${OPT_RECURSE-}" ]; then
		for consumer in `pkg_info -qR $pkg`; do
			report -t $consumer
			maybe_uninstall $consumer
			maybe_delete $consumer
		done
	fi
	maybe_uninstall $pkg
	maybe_delete $pkg
done
