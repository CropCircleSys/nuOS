#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.9.2a24 - bin/nu_install_pkg - LICENSE: BSD_SMPL
#
# Copyright (c) 2008-2014 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is subject to the terms of the Simplified BSD License.
# If a copy of the Simplified BSD License was not distributed alongside this file, you can
# obtain one at http://www.freebsd.org/copyright/freebsd-license.html . This software
# project is not affiliated with the FreeBSD Project.
#
# Official updates and community support available at http://nuos.org .
# Other licensing options and professional services available at http://ccsys.com .

NUOS_VER=0.0.9.2a24

while getopts AC:MRvyY OPT; do case $OPT in
	A) OPT_ARG_SUBPROCESS=y;;
	C) CHROOTDIR=$OPTARG;;
	M) OPT_NOMAKE=y;;
	R) OPT_NORECURSE=y;;
	v) OPT_VERBOSE=y;;
	y) OPT_YES=y;;
	Y) OPT_YES_SUBPROCESS=y;;
esac; done; shift $(($OPTIND-1))

. "$(dirname "$(realpath "$0")")/../lib/nu_system.sh"
. "$(dirname "$(realpath "$0")")/../lib/nu_make.sh"
. "$(dirname "$(realpath "$0")")/../lib/nu_ports.sh"
. "$(dirname "$(realpath "$0")")/../lib/nu_install.sh"

maybe_yell

if [ -n "${OPT_YES-}" ]; then
	yes | sh $0 ${OPT_ARG_SUBPROCESS:+-A} ${OPT_NOMAKE:+-M} ${OPT_NORECURSE:+-R} ${OPT_VERBOSE:+-v} ${CHROOTDIR:+-C $CHROOTDIR} -Y $@
	exit $?
fi

require_ports_tree
prepare_make_conf make_conf retire_make_conf_cmd

metainfo_dir="$(dirname "$(realpath "$0")")/../pkg"
if [ -z "${OPT_ARG_SUBPROCESS-}" -a -n "${CHROOTDIR-}" ]; then
	if [ ! -d "$CHROOTDIR/usr/ports/packages/All" ]; then
		mount -t nullfs /usr/ports/packages "$CHROOTDIR/usr/ports/packages"
		nullfs_mounted=y
	fi
fi
for port in $*; do
	uni=`echo $port | tr / _`
	args="$metainfo_dir/$uni.args"
	if [ -z "${OPT_ARG_SUBPROCESS-}" ] && [ -f "$args" ]; then
		sh $0 ${OPT_NOMAKE:+-M} ${OPT_NORECURSE:+-R} ${OPT_VERBOSE:+-v} ${CHROOTDIR:+-C $CHROOTDIR} -A `cat "$args"` $port
	else
		script="$metainfo_dir/$uni.sh"
		pkg=`pkg_name $port`
		pkg_file=/usr/ports/packages/All/$pkg.tbz
		if [ ! -f $pkg_file ]; then
			[ -z "${OPT_NOMAKE-}" -a -z "${OPT_NORECURSE-}" ]
			port_deps def_opts my_opts build_deps run_deps $port
			retire_tmp def_opts
			retire_tmp my_opts
			sets_union all_deps "$build_deps" "$run_deps"
			retire_tmp build_deps
			sister nu_install_pkg ${OPT_YES_SUBPROCESS:+-y} `cat "$all_deps"`
			retire_tmp all_deps
			if [ -n "${CHROOTDIR-}" ]; then
				sister nu_install_pkg -C $CHROOTDIR ${OPT_YES_SUBPROCESS:+-y} `cat "$run_deps"`
			fi
			retire_tmp run_deps
			destdir=
			if [ -f "$script" ]; then
				pkg_step=pre-build
				. "$script"
			fi
			(cd /usr/ports/$port && make -DNOCLEANDEPENDS clean && make "__MAKE_CONF=$make_conf" -DBATCH install package && make -DNOCLEANDEPENDS clean)
			if [ -f "$script" ]; then
				pkg_step=post-build
				. "$script"
			fi
		fi
		if [ ! -d "${CHROOTDIR-}/var/db/pkg/$pkg" ]; then
			if [ -z "${OPT_NORECURSE-}" ]; then
				pkg_deps -m -p needed_deps $pkg
				sister nu_install_pkg ${CHROOTDIR:+-C $CHROOTDIR} ${OPT_YES_SUBPROCESS:+-y} `cat "$needed_deps"`
				retire_tmp needed_deps
			fi
			destdir="${CHROOTDIR-}"
			if [ -f "$script" ]; then
				pkg_step=pre-install
				. "$script"
			fi
			(cd / && pkg_add ${CHROOTDIR:+-C $CHROOTDIR} -F -i $pkg_file)
			if [ -f "$script" ]; then
				pkg_step=post-install
				. "$script"
			fi
		fi
		[ -d "${CHROOTDIR-}/var/db/pkg/$pkg" ]
	fi
done
if [ -n "${nullfs_mounted-}" ]; then
	umount "$CHROOTDIR/usr/ports/packages"
fi

$retire_make_conf_cmd make_conf
