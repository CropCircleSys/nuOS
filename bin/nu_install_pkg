#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.9.2b1 - bin/nu_install_pkg - LICENSE: BSD_SMPL
#
# Copyright (c) 2008-2013 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is subject to the terms of the Simplified BSD License.
# If a copy of the Simplified BSD License was not distributed alongside this file, you can
# obtain one at http://www.freebsd.org/copyright/freebsd-license.html . This software
# project is not affiliated with the FreeBSD Project.
#
# Official updates and community support available at http://nuos.org .
# Other licensing options and professional services available at http://ccsys.com .

NUOS_VER=0.0.9.2b1

while getopts C:Mvy OPT && [ $OPT != '?' ]; do
	case $OPT in
		C)
			CHROOTDIR="$OPTARG"
			;;
		M)
			OPT_NOMAKE=y
			;;
		v)
			OPT_VERBOSE=y
			;;
		y)
			OPT_YES=y
			;;
		*)
			echo "usage: `basename \"$0\"` [-Mvy] [-C chroot_dir] port_origin ..." >&2
			exit 1
	esac
done
while [ $OPTIND -gt 1 ]; do
	shift
	OPTIND=$(($OPTIND - 1))
done

. "$(dirname "$(realpath "$0")")/../lib/nu_system.sh"
. "$(dirname "$(realpath "$0")")/../lib/nu_install.sh"

maybe_yell

if [ -n "${OPT_YES-}" ]; then
	yes | sh $0 ${OPT_NOMAKE:+-M} ${OPT_VERBOSE:+-v} ${CHROOTDIR:+-C $CHROOTDIR} $@
	exit $?
fi

require_ports_tree
prepare_make_conf make_conf cmd_to_retire_make_conf

if [ -n "${CHROOTDIR-}" ]; then
	if [ ! -d "$CHROOTDIR/usr/ports/packages/All" ]; then
		mount -t nullfs /usr/ports/packages "$CHROOTDIR/usr/ports/packages"
		nullfs_mounted=y
	fi
fi
for port in $*; do
	uni=`echo $port | tr / _`
	script_dir="$(dirname "$(realpath "$0")")/../pkg/$uni"
	pkg=`cd /usr/ports/$port && make -V PKGNAME`
	pkg_file=/usr/ports/packages/All/$pkg.tbz
	if [ ! -f $pkg_file ]; then
		[ -z "${OPT_NOMAKE-}" ]
		destdir=
		if [ -f "$script_dir/before.sh" ]; then
			. "$script_dir/before.sh"
		fi
		(cd /usr/ports/$port && make clean && make __MAKE_CONF=$make_conf -DBATCH package-recursive && make clean)
		if [ -f "$script_dir/after.sh" ]; then
			. "$script_dir/after.sh"
		fi
	fi
	if [ ! -d "${CHROOTDIR-}/var/db/pkg/$pkg" ]; then
		destdir="${CHROOTDIR-}"
		if [ -f "$script_dir/before.sh" ]; then
			. "$script_dir/before.sh"
		fi
		(cd / && pkg_add ${CHROOTDIR:+-C $CHROOTDIR} $pkg_file)
		if [ -f "$script_dir/after.sh" ]; then
			. "$script_dir/after.sh"
		fi
	fi
done
if [ -n "${nullfs_mounted-}" ]; then
	umount "$CHROOTDIR/usr/ports/packages"
fi

$cmd_to_retire_make_conf $make_conf
