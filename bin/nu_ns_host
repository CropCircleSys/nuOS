#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.11.0b0.1 - bin/nu_ns_host - LICENSE: MOZ_PUB
#
# Copyright (c) 2008-2017 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is subject to the terms of the Mozilla Public License, v2.0.
# If a copy of the MPL was not distributed alongside this file, you can obtain one at
# http://mozilla.org/MPL/2.0/ . This software project is not affiliated with the Mozilla
# Foundation.
#
# Official updates and community support available at https://nuos.org .
# Other licensing options and professional services available at https://ccsys.com .

NUOS_VER=0.0.11.0b0.1

. "$(dirname "$(realpath "$0")")/../lib/nu_system.sh"

while getopts A:C:h:i:klM:t:v OPT; do case $OPT in
	A) ALTERNATE=$OPTARG;;
	C) CHROOTDIR=$OPTARG;;
	h) HOST_NAME=$OPTARG;;
	i) push PUB_IPS $OPTARG;;
	k) OPT_EXPORT_KEY_FINGERPRINTS=y;;
	l) OPT_LITE=y;;
	M) MODE=$OPTARG; case $MODE in
		master|slave) ;; *) exit 22; esac;;
	t) SOFTWARE=$OPTARG; case $SOFTWARE in
		djb|knot) ;; *) exit 22; esac;;
	v) OPT_VERBOSE=y;;
esac; done; shift $(($OPTIND-1))
[ $# = 0 ]

. "$(dirname "$(realpath "$0")")/../lib/nu_common.sh"

if [ -n "${OPT_EXPORT_KEY_FINGERPRINTS-}" ]; then
	ex=1
	for k in `keymgr zone key list $HOST_NAME | cut -w -f 3`; do
		if [ 257 = `keymgr zone key show $HOST_NAME $k | grep '^flags' | cut -w -f 2` ]; then
			ex=0
			keymgr zone key ds $HOST_NAME $k
		fi
	done
	exit $ex
fi

nuos_init

: ${SOFTWARE:=knot}
if [ -z "${PUB_IPS-}" ]; then
	case $SOFTWARE in
		djb)
			for dir in `ls -d "${CHROOTDIR-}/var/service/tinydns-"*`; do
				push PUB_IPS ${dir##*-}
			done
		;;
		knot)
			[ -f "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" ]
			! diff -q "${CHROOTDIR-}/usr/local/etc/knot/knot.conf.sample" "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" > /dev/null 2>&1
			master_refs=`sed -n -E -e '/^template:/,/^[^[:blank:]]/p' "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" | sed -e '1d;$d' | sed -n -E -e '/^[[:blank:]]*- id: default$/,/^[[:blank:]]*- id: /p' | sed -n -E -e '1d;$d;/^[[:blank:]]*master:[[:blank:]]*.+/=' | wc -l | xargs`
			if [ $master_refs -ge 1 ]; then
				default_mode=slave
			else
				default_mode=master
			fi
			echo 'mode            -M MODE           ' ${MODE:=$default_mode}
			PUB_IPS="`sed -n -E -e '/^@	A+\>/,/^[^@[:blank:]]/{/^(@	A+\>|	A+\>)/p;}' "${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.com.zone" | cut -f 3 | xargs`"
		;;
	esac
fi

echo 'host name       -h HOST_NAME      ' $HOST_NAME
echo 'public ips      -i PUB_IPS        ' $PUB_IPS
echo -n 'lightweight     -l OPT_LITE        ' && [ -n "${OPT_LITE-}" ] && echo set || echo null
echo

maybe_yell

case $SOFTWARE in
	djb)
		for ip in $PUB_IPS; do
			(
				cd "${CHROOTDIR-}/var/service/tinydns-$ip/root"
				if [ -z "${OPT_LITE-}" ]; then
					for ip_ in $PUB_IPS; do
						./add-ns $HOST_NAME $ip_
					done
					./add-mx $HOST_NAME $ip
				fi
				./add-host $HOST_NAME $ip || ./add-alias $HOST_NAME $ip
				./add-alias www.$HOST_NAME $ip
				make
			)
		done
	;;
	knot)
		[ $MODE = $default_mode ]
		[ 1 = `echo "$(sed -n -E -e '/^zone:/,${/^([[:blank:]]|$)/d;p;}' "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf")" | wc -l | xargs` ]
		zone=$HOST_NAME
		case $MODE in
			master)
				if [ ! -d "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}" ]; then
					mkdir "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}"
					chown knot:knot "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}"
				fi
				new_serial=`date +%Y%m%d`01
				if [ -n "${OPT_LITE-}" ]; then
					[ ! -f "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone" ]
					while [ ! -f "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone" ]; do
						echo $zone | grep -q '\.'
						zone=${zone#*.}
					done
					host=${HOST_NAME%.$zone}
					old_serial=`sed -n -E -e '/\<serial[[:blank:]]*$/{s/^[[:blank:]]*([[:digit:]]+).*$/\1/;p;}' "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone"`
					if [ $old_serial -ge $new_serial ]; then
						new_serial=$(($old_serial + 1))
					fi
					sed -i '' -E -e "/\<serial[[:blank:]]*$/s/[[:digit:]]+/$new_serial/" "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone"
					echo >> "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone"
					i=1
					for ip in $PUB_IPS; do
						cat >> "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone" <<EOF
`[ $i -gt 1 ] || echo $host`	A	$ip
EOF
						i=$(($i + 1))
					done
				else
					sed -E -e "s/\<example\\.com\>/$zone/g;/\<serial[[:blank:]]*$/s/[[:digit:]]+/$new_serial/" "${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.com.zone" > "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone"
				fi
				for ip in $PUB_IPS; do
					rz=`rev_zone $ip`
					if [ ! -f "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$rz.zone" ]; then
						sed -E -e "s/\<example\\.in-addr\\.arpa\>/$rz/;s/\<example\\.in-addr\\.arpa\>/$HOST_NAME/;/\<serial[[:blank:]]*$/s/[[:digit:]]+/$new_serial/;s/\<example\\.com\>/$HOST_NAME/" "${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.in-addr.arpa.zone" > "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$rz.zone"
						echo "  - domain: $rz" >> "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf"
					fi
				done
			;;
			slave)
				[ -z "${OPT_LITE-}" ]
			;;
		esac
		echo "  - domain: $zone" >> "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf"
	;;
esac


echo "Configured host $HOST_NAME in name server."
