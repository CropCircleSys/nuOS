#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.11.0b0.1 - bin/nu_ns_host - LICENSE: MOZ_PUB
#
# Copyright (c) 2008-2017 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is subject to the terms of the Mozilla Public License, v2.0.
# If a copy of the MPL was not distributed alongside this file, you can obtain one at
# https://www.mozilla.org/MPL/2.0 . This software project is not affiliated with the
# Mozilla Foundation.
#
# Official updates and community support available at https://nuos.org .
# Other licensing options and professional services available at https://ccsys.com .

NUOS_VER=0.0.11.0b0.1

. "$(dirname "$(realpath "$0")")/../lib/nu_system.sh"

while getopts A:C:h:i:klM:o:r:t:v OPT; do case $OPT in
	A) ALTERNATE=$OPTARG;;
	C) CHROOTDIR=$OPTARG;;
	h) HOST_NAME=$OPTARG;;
	i) push PUB_IPS $OPTARG;;
	k) OPT_EXPORT_KEY_FINGERPRINTS=y;;
	l) OPT_LITE=y;;
	M) MODE=$OPTARG; case $MODE in
		master|slave) ;; *) exit 22; esac;;
	o) type=$OPTARG; eval file=\"\$$OPTIND\"; case $type in
		parent_zone)
			setvar out_$type "$file";;
		*) exit 22; esac; shift $OPTIND;;
	r) REC_TYPE="`echo "$OPTARG" | tr '[:lower:]' '[:upper:]'`"; OPT_LITE=y;;
	t) SOFTWARE=$OPTARG; case $SOFTWARE in
		djb|knot) ;; *) exit 22; esac;;
	v) OPT_VERBOSE=y;;
esac; done; shift $(($OPTIND-1))
[ $# = 0 ]

. "$(dirname "$(realpath "$0")")/../lib/nu_common.sh"

if [ -n "${OPT_EXPORT_KEY_FINGERPRINTS-}" ]; then
	ex=1
	for k in `${CHROOTDIR:+chroot "$CHROOTDIR"} keymgr ${ALTERNATE:+-c /usr/local/etc/knot/knot_ALTERNATE.conf} zone key list $HOST_NAME | cut -w -f 3`; do
		if [ 257 = `${CHROOTDIR:+chroot "$CHROOTDIR"} keymgr ${ALTERNATE:+-c /usr/local/etc/knot/knot_ALTERNATE.conf} zone key show $HOST_NAME $k | grep '^flags' | cut -w -f 2` ]; then
			ex=0
			${CHROOTDIR:+chroot "$CHROOTDIR"} keymgr ${ALTERNATE:+-c /usr/local/etc/knot/knot_ALTERNATE.conf} zone key ds $HOST_NAME $k
		fi
	done
	exit $ex
fi

nuos_init

: ${SOFTWARE:=knot}
case $SOFTWARE in
	djb)
		if [ -z "${PUB_IPS-}" ]; then
			for dir in `ls -d "${CHROOTDIR-}/var/service/tinydns-"*`; do
				push PUB_IPS ${dir##*-}
			done
		fi
	;;
	knot)
		[ -f "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" ]
		! diff -q "${CHROOTDIR-}/usr/local/etc/knot/knot.conf.sample" "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" > /dev/null 2>&1
		master_refs=`sed -n -E -e '/^template:/,/^[^[:blank:]]/p' "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" | sed -e '1d;$d' | sed -n -E -e '/^[[:blank:]]*- id: default$/,/^[[:blank:]]*- id: /p' | sed -n -E -e '1d;$d;/^[[:blank:]]*master:[[:blank:]]*.+/=' | wc -l | xargs`
		if [ $master_refs -ge 1 ]; then
			default_mode=slave
		else
			default_mode=master
		fi
		echo 'mode            -M MODE           ' ${MODE:=$default_mode}
		if [ -z "${PUB_IPS-}" ]; then
			PUB_IPS="`sed -n -E -e '/^@	A+\>/,/^[^@[:blank:]]/{/^(@	A+\>|	A+\>)/p;}' "${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.com.zone" | cut -f 3 | xargs`"
		fi
	;;
esac

[ -n "${PUB_IPS-}" ] || unset PUB_IPS

echo 'host name       -h HOST_NAME      ' $HOST_NAME
echo 'public ips      -i PUB_IPS        ' $PUB_IPS
: ${REC_TYPE:=A}
echo -n 'record type     -r REC_TYPE        ' && [ -n "${OPT_LITE-}" ] && echo $REC_TYPE || echo n/a
echo -n 'lightweight     -l OPT_LITE        ' && [ -n "${OPT_LITE-}" ] && echo set || echo null
echo

maybe_yell

[ -z "${out_parent_zone-}" ] || [ -f "$out_parent_zone" -a -w "$out_parent_zone" -a ! -s "$out_parent_zone" ]

case $SOFTWARE in
	djb)
		for ip in $PUB_IPS; do
			(
				cd "${CHROOTDIR-}/var/service/tinydns-$ip/root"
				if [ -z "${OPT_LITE-}" ]; then
					for ip_ in $PUB_IPS; do
						./add-ns $HOST_NAME $ip_
					done
					./add-mx $HOST_NAME $ip
				fi
				./add-host $HOST_NAME $ip || ./add-alias $HOST_NAME $ip
				./add-alias www.$HOST_NAME $ip
				make
			)
		done
	;;
	knot)
		[ $MODE = $default_mode ]
		zone=$HOST_NAME
		case $MODE in
			master)
				if [ ! -d "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}" ]; then
					mkdir "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}"
					chown knot:knot "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}"
				fi
				if [ -n "${OPT_LITE-}" ]; then
					while [ ! -f "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone" ]; do
						echo $zone | grep -q '\.' || (echo "could not find zone file (are we the configured master of a parent zone?)" >&2 && exit 85)
						zone=${zone#*.}
					done
					if [ "$HOST_NAME" = "$zone" ]; then
						host=@
					else
						host=${HOST_NAME%.$zone}
					fi
					read -r _ _ _ type _ _ _ _ ttl _ _ <<EOF
$(${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} zone-read $zone @ SOA)
EOF
					[ SOA = "$type" ]
					${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} zone-begin $zone
					for ip in $PUB_IPS; do
						${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} zone-set $zone $host $ttl $REC_TYPE $ip
					done
					${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} zone-commit $zone
				else
					sed -E -e "s/\<example\\.com\>/$zone/g;/\<serial[[:blank:]]*$/s/[[:digit:]]+/`date +%Y%m%d`01/" "${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.com.zone" > "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone"
				fi
				if [ A = $REC_TYPE -o AAAA = $REC_TYPE ]; then # TODO: don't get your hopes up yet, there's a hundred things left to do to support IPv6
					for ip in $PUB_IPS; do
						rz=`rev_zone $ip`
						if [ ! -f "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$rz.zone" ]; then
							sed -E -e "s/\<example\\.in-addr\\.arpa\>/$rz/;s/\<example\\.in-addr\\.arpa\>/$HOST_NAME/;/\<serial[[:blank:]]*$/s/[[:digit:]]+/$new_serial/;s/\<example\\.com\>/$HOST_NAME/" "${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.in-addr.arpa.zone" > "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$rz.zone"
							[ -n "${conf_began-}" ] || { ${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} conf-begin && conf_began=y; }
							${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} conf-set "zone[$rz]"
							${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} conf-set "zone[$rz].file" "/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$rz.zone"
						fi
					done
				fi
			;;
			slave)
				[ -z "${OPT_LITE-}" ]
			;;
		esac
		if [ -z "${OPT_LITE-}" ]; then
			[ -n "${conf_began-}" ] || { ${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} conf-begin && conf_began=y; }
			${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} conf-set "zone[$zone]"
			${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} conf-set "zone[$zone].file" "/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$zone.zone"
			echo "  - domain: $zone" >> "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf"
		fi
		[ -z "${conf_began-}" ] || ${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} conf-commit
	;;
esac

[ -z "${out_parent_zone-}" ] || echo ${zone:-$HOST_NAME} >| "$out_parent_zone"


echo "Configured host $HOST_NAME in name server."
