#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.11.1a1 - bin/nu_ns_host - LICENSE: MOZ_PUB
#
# Copyright (c) 2008-2017 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is subject to the terms of the Mozilla Public License, v2.0.
# If a copy of the MPL was not distributed alongside this file, you can obtain one at
# https://www.mozilla.org/MPL/2.0 . This software project is not affiliated with the
# Mozilla Foundation.
#
# Official updates and community support available at https://nuos.org .
# Other licensing options and professional services available at https://ccsys.com .

NUOS_VER=0.0.11.1a1

. "$(dirname "$(realpath "$0")")/../lib/nu_system.sh"

while getopts A:c:C:dh:i:klM:r:st:vw OPT; do case $OPT in
	A) ALTERNATE=$OPTARG;;
	c) CA_ZONE=$OPTARG;;
	C) CHROOTDIR=$OPTARG;;
	d) incr OPT_DELETE 1;;
	h) HOST_NAME=$OPTARG;;
	i) push PUB_IPS $OPTARG;;
	k) OPT_EXPORT_KEY_FINGERPRINTS=y;;
	l) OPT_LITE=y;;
	M) MODE=$OPTARG; case $MODE in
		master|slave) ;; *) exit 22; esac;;
	r) REC_TYPE="`echo "$OPTARG" | tr '[:lower:]' '[:upper:]'`"; OPT_LITE=y;;
	s) OPT_SINGLE_RECORD=y;;
	t) TTL=$OPTARG;;
	v) OPT_VERBOSE=y;;
	w) OPT_CA_WILDCARD=y;;
esac; done; shift $(($OPTIND-1))
[ $# = 0 ]

. "$(dirname "$(realpath "$0")")/../lib/nu_common.sh"

if [ -n "${OPT_EXPORT_KEY_FINGERPRINTS-}" ]; then
	out=$(${CHROOTDIR:+chroot "$CHROOTDIR"} keymgr ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf} $HOST_NAME ds)
	if [ -n "$out" ]; then
		cat <<EOF
$out
EOF
		exit 0
	else
		exit 1
	fi
fi

if [ -n "${CA_ZONE-}" ]; then
	sister nu_ns_host ${CHROOTDIR:+-C "$CHROOTDIR"} ${ALTERNATE:+-A $ALTERNATE} -d -r caa -h $HOST_NAME
	if [ x-d != "x${CA_ZONE-}" -a d != "${CA_ZONE-}" -a -z "${OPT_DELETE-}" ]; then
		if [ -n "${OPT_CA_WILDCARD-}" ]; then
			wild_zone=$CA_ZONE
		else
			wild_zone=";"
		fi
	else
		CA_ZONE=";"
		wild_zone=";"
	fi
	sister nu_ns_host ${CHROOTDIR:+-C "$CHROOTDIR"} ${ALTERNATE:+-A $ALTERNATE} -s -r caa -h $HOST_NAME -i "128 issue \"$CA_ZONE\""
	sister nu_ns_host ${CHROOTDIR:+-C "$CHROOTDIR"} ${ALTERNATE:+-A $ALTERNATE} -s -r caa -h $HOST_NAME -i "128 issuewild \"$wild_zone\""
	exit 0
fi

nuos_init

: ${SOFTWARE:=knot}
case $SOFTWARE in
	djb)
		if [ -z "${PUB_IPS-}" ]; then
			for dir in `ls -d "${CHROOTDIR-}/var/service/tinydns-"*`; do
				push PUB_IPS ${dir##*-}
			done
		fi
	;;
	knot)
		[ -f "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" ]
		! diff -q "${CHROOTDIR-}/usr/local/etc/knot/knot.conf.sample" "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" > /dev/null 2>&1
		master_refs=`sed -n -E -e '/^template:/,/^[^[:blank:]]/p' "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" | sed -e '1d;$d' | sed -n -E -e '/^[[:blank:]]*- id: default$/,/^[[:blank:]]*- id: /p' | sed -n -E -e '1d;$d;/^[[:blank:]]*master:[[:blank:]]*.+/=' | wc -l | xargs`
		if [ $master_refs -ge 1 ]; then
			default_mode=slave
		else
			default_mode=master
		fi
		echo 'mode            -M MODE           ' ${MODE:=$default_mode}
		if [ -z "${PUB_IPS-}" ]; then
			PUB_IPS="`sed -n -E -e '/^@	A+\>/,/^[^@[:blank:]]/{/^(@	A+\>|	A+\>)/p;}' "${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.com.zone" | cut -f 3 | xargs`"
		fi
	;;
esac

[ -n "${PUB_IPS-}" ] || unset PUB_IPS

echo 'host name       -h HOST_NAME      ' $HOST_NAME
echo -n 'delete          -d OPT_DELETE      ' && [ -n "${OPT_DELETE-}" ] && echo set || echo null
echo -n 'public ips      -i PUB_IPS         ' && [ -z "${OPT_DELETE-}" -a -z "${OPT_SINGLE_RECORD-}" ] && echo $PUB_IPS || echo n/a
: ${REC_TYPE:=A}
echo -n 'record type     -r REC_TYPE        ' && [ -n "${OPT_LITE-}" ] && echo $REC_TYPE || echo n/a
echo -n 'lightweight     -l OPT_LITE        ' && [ -n "${OPT_LITE-}" ] && echo set || echo null
echo

maybe_yell

case $SOFTWARE in
	djb)
		for ip in $PUB_IPS; do
			(
				cd "${CHROOTDIR-}/var/service/tinydns-$ip/root"
				if [ -z "${OPT_LITE-}" ]; then
					for ip_ in $PUB_IPS; do
						./add-ns $HOST_NAME $ip_
					done
					./add-mx $HOST_NAME $ip
				fi
				./add-host $HOST_NAME $ip || ./add-alias $HOST_NAME $ip
				./add-alias www.$HOST_NAME $ip
				make
			)
		done
	;;
	knot)
		[ $MODE = $default_mode ]
		zone=$HOST_NAME
		knotc_cmd="$(echo ${CHROOTDIR:+chroot "$CHROOTDIR"} knotc ${ALTERNATE:+-c /usr/local/etc/knot/knot_$ALTERNATE.conf})"
		case $MODE in
			master)
				if [ ! -d "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}" ]; then
					mkdir "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}"
					chown knot:knot "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}"
				fi
				new_serial=`date +%Y%m%d`01
				if [ -n "${OPT_LITE-}" ]; then
					zone=$(ns_master_zone ${CHROOTDIR:+-c} ${ALTERNATE:+-A $ALTERNATE} $HOST_NAME)
					if [ "$HOST_NAME" = "$zone" ]; then
						host=@
					else
						host=${HOST_NAME%.$zone}
					fi
					if [ $REC_TYPE = CAA -o '(' $REC_TYPE = TXT -a '(' $host = _acme-challenge -o $host != "${host#_acme-challenge.}" ')' ')' ]; then
						default_ttl=60
					else
						default_ttl=3600
					fi
					: ${TTL:=$default_ttl}
					$knotc_cmd zone-begin $zone
					if [ -n "${OPT_SINGLE_RECORD-}" ]; then
						if [ -n "${OPT_DELETE-}" ]; then
							$knotc_cmd zone-unset $zone $host $REC_TYPE "$PUB_IPS"
						else
							$knotc_cmd zone-set $zone $host $TTL $REC_TYPE "$PUB_IPS"
						fi
					else
						if [ -n "${OPT_DELETE-}" ]; then
							$knotc_cmd zone-unset $zone $host $([ A = $REC_TYPE -o AAAA = $REC_TYPE ] || echo $REC_TYPE) || ex=1
						else
							for ip in $PUB_IPS; do
								$knotc_cmd zone-set $zone $host $TTL $REC_TYPE $ip
							done
						fi
					fi
					$knotc_cmd zone-commit $zone
				else
					if [ -z "${OPT_DELETE-}" ]; then
						sed -E -e "
							s/\<example\\.com\>/$HOST_NAME/g
							/\<serial[[:blank:]]*$/s/[[:digit:]]+/$new_serial/" \
								"${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.com.zone" \
									> "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$HOST_NAME.zone"
					fi
				fi
				if [ -z "${OPT_DELETE-}" -a '(' A = $REC_TYPE -o AAAA = $REC_TYPE ')' ]; then
					for ip in $PUB_IPS; do
						rz=`rev_zone $ip`
						if [ ! -f "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$rz.zone" ]; then
							sed -E -e "
								s/\<example\\.in-addr\\.arpa\>/$rz/
								s/\<example\\.in-addr\\.arpa\>/$HOST_NAME/
								/\<serial[[:blank:]]*$/s/[[:digit:]]+/$new_serial/" \
									"${CHROOTDIR-}/usr/local/etc/knot/example${ALTERNATE:+_${ALTERNATE}}.in-addr.arpa.zone" \
										> "${CHROOTDIR-}/var/db/knot${ALTERNATE:+_${ALTERNATE}}/$rz.zone"
							[ -n "${conf_began-}" ] || { $knotc_cmd conf-begin && conf_began=y; }
							$knotc_cmd conf-set "zone[$rz]"
							cat >> "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" <<EOF
  - domain: $rz
EOF
						fi
					done
				fi
			;;
			slave)
				[ -z "${OPT_LITE-}" ]
			;;
		esac
		if [ -z "${OPT_LITE-}" ]; then
			: ${zone:=$HOST_NAME}
			[ -n "${conf_began-}" ] || { $knotc_cmd conf-begin && conf_began=y; }
			if [ -n "${OPT_DELETE-}" ]; then
				$knotc_cmd conf-unset "zone[$zone]"
				zone_escd="$(echo $zone | sed -e 's/\./\\./g')"
				sed -i '' -e "/^[[:blank:]]*-[[:blank:]]*domain:[[:blank:]]*$zone_escd[[:blank:]]*\$/d" \
					"${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf"
			else
				$knotc_cmd conf-set "zone[$zone]"
				cat >> "${CHROOTDIR-}/usr/local/etc/knot/knot${ALTERNATE:+_${ALTERNATE}}.conf" <<EOF
  - domain: $zone
EOF
			fi
		fi
		[ -z "${conf_began-}" ] || $knotc_cmd conf-commit
	;;
esac

if [ -z "${OPT_DELETE-}" -o -z "${ex-}" ]; then
	echo "Configured host $HOST_NAME in name server."
fi

[ 2 -le "${OPT_DELETE-0}" ] || exit ${ex-0}
