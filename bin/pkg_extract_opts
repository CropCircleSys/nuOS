#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.9.2a25 - bin/pkg_extract_opts - LICENSE: PUB_DOM
#
# Written in 2013 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is placed in the public domain by the author, who disclaims all
# liability. More information can be found in the license file.
#
# Official updates and community support available at http://nuos.org .
# Other licensing options and professional services available at http://ccsys.com .

# This produces a new ports options textual db from the chosen options from the pkg db
# for installed ports/packages currently on the system. Its format is current as of
# FreeBSD 9.2-RELEASE and 2013-08-12-0000 /usr/ports/Mk

NUOS_VER=0.0.9.2a25

while getopts d:v OPT; do case $OPT in
	d) DBDIR=$OPTARG;;
	v) OPT_VERBOSE=y;;
esac; done; shift $(($OPTIND-1))
[ $# = 0 ]

. "$(dirname "$(realpath "$0")")/../lib/nu_system.sh"

: ${DBDIR:=/var/db/ports}
mkdir $DBDIR
for pkg in `ls /var/db/pkg | grep -v '^pkgdb.db$'`; do
	opts="`sed -n -e '/^@comment OPTIONS:/{s///;p;}' /var/db/pkg/$pkg/+CONTENTS`"
	if [ -n "$opts" ]; then
		org=`pkg_info -q -o $pkg`
		uni=`echo $org | tr / _`
		require_tmp tempfile
		optlist=''
		for opt in $opts; do
			bareopt="${opt#[-+]}"
			if [ "$bareopt" != "$opt" ]; then
				val="${opt%$bareopt}"
				if [ -n "${optlist:-}" ]; then
					optlist="$optlist $bareopt"
				else
					optlist=$bareopt
				fi
				if [ "$val" = "+" ]; then
					echo "OPTIONS_FILE_SET+=$bareopt" >> "$tempfile"
				else
					echo "OPTIONS_FILE_UNSET+=$bareopt" >> "$tempfile"
				fi
			fi
		done
		mkdir -p $DBDIR/$uni
		cat - "$tempfile" >> $DBDIR/$uni/options <<-EOF
			# This file is auto-generated by 'make config'.
			# (Or extracted using 'pkg_extract_opts' as happens to be the case.)
			# Options for $pkg
			_OPTIONS_READ=$pkg
			_FILE_COMPLETE_OPTIONS_LIST=$optlist
		EOF
		retire_tmp tempfile
		if [ -n "${OPT_VERBOSE-}" ]; then
			echo $uni >&2
		fi
	fi
done
