#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.9.2a1 - bin/pkg_extract_opts - LICENSE: PUB_DOM
#
# Written in 2013 Chad Jacob Milios and Crop Circle Systems, Inc.
# All rights reserved.
#
# This Source Code Form is placed in the public domain by the author, who disclaims all
# liability. More information can be found in the license file.
#
# Official updates and community support available at http://nuos.org .
# Other licensing options and professional services available at http://ccsys.com .

# This produces a new ports options textual db from the chosen options from the pkg db
# for installed ports/packages currently on the system. Its format is current as of
# FreeBSD 9.1-RELEASE and 2013-02-21-0000 /usr/ports/Mk

while getopts d:v OPT; do
	case $OPT in
		d)
			DBDIR="$OPTARG"
			;;
		v)
			OPT_VERBOSE=y
			;;
		*)
			echo "usage: `basename $0` [-d dbdir]" >&2
			exit 1
	esac
done

: ${DBDIR:=/var/db/ports}
mkdir $DBDIR
for pkg in `ls /var/db/pkg | grep -v '^pkgdb.db$'`; do
	opts="`grep '^@comment OPTIONS:' /var/db/pkg/$pkg/+CONTENTS | sed -e 's/^@comment OPTIONS://'`"
	if [ -n "$opts" ]; then
		org=`pkg_info -q -o $pkg`
		pwd=$PWD
		cd /usr/ports/$org
		uni=`make -V UNIQUENAME`
		cd $pwd
		tempfile=`mktemp -t $(basename "$0").$$`
		optlist=''
		for opt in $opts; do
			bareopt="${opt#[-+]}"
			if [ "$bareopt" != "$opt" ]; then
				val="${opt%$bareopt}"
				if [ -n "${optlist:-}" ]; then
					optlist="$optlist $bareopt"
				else
					optlist=$bareopt
				fi
				if [ "$val" = "+" ]; then
					echo "OPTIONS_FILE_SET+=$bareopt" >> $tempfile
				else
					echo "OPTIONS_FILE_UNSET+=$bareopt" >> $tempfile
				fi
			fi
		done
		mkdir -p $DBDIR/$uni
		cat - $tempfile >> $DBDIR/$uni/options <<-EOF
			# This file is auto-generated by 'make config'.
			# (Or extracted using 'pkg_extract_opts' as happens to be the case.)
			# Options for $pkg
			_OPTIONS_READ=$pkg
			_FILE_COMPLETE_OPTIONS_LIST=$optlist
		EOF
		rm $tempfile
		if [ -n "${OPT_VERBOSE-}" ]; then
			echo $uni >&2
		fi
	fi
done
